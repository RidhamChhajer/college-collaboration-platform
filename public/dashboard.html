<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>College Collaboration Platform - Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'brown': {
              700: '#8B4513',
              800: '#654321'
            }
          }
        }
      }
    }
  </script>
</head>
<body class="bg-gradient-to-br from-amber-50 to-orange-100 min-h-screen">
  <!-- Header -->
  <header class="bg-white shadow-md border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <div class="flex items-center gap-3">
          <!-- Menu Button -->
          <button onclick="toggleMenu()" id="menuBtn" 
                  class="bg-amber-600 hover:bg-amber-700 text-white p-2 rounded-md transition">
            ‚ò∞ Menu
          </button>
          <h1 class="text-2xl font-bold text-amber-800">üéì College Collaboration Platform</h1>
        </div>
        <div class="flex items-center gap-4">
          <button onclick="logout()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md transition">
            Logout
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Left Side Menu -->
  <div id="sideMenu" class="hidden fixed top-16 left-0 bg-white shadow-lg border-r border-gray-200 w-64 h-full z-50 transform transition-transform duration-300">
    <div class="p-4">
      <h3 class="text-lg font-semibold text-gray-800 mb-4">Navigation</h3>
      
      <!-- Menu Items -->
      <div class="space-y-2">
        <button onclick="showDashboard()" 
                class="w-full text-left px-4 py-3 rounded-lg hover:bg-amber-50 transition flex items-center gap-2">
          <span>üìä</span> Dashboard
        </button>
        
        <button onclick="goToProfileForm()" 
                class="w-full text-left px-4 py-3 rounded-lg hover:bg-green-50 transition flex items-center gap-2">
          <span>üìù</span> Submit Profile
        </button>
        
        <button onclick="editProfile()" 
                class="w-full text-left px-4 py-3 rounded-lg hover:bg-yellow-50 transition flex items-center gap-2">
          <span>‚úèÔ∏è</span> Edit Profile
        </button>
        
        <button onclick="showSettings()" 
                class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-50 transition flex items-center gap-2">
          <span>‚öôÔ∏è</span> Settings
        </button>
      </div>
    </div>
  </div>

  <!-- Overlay for mobile -->
  <div id="overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40" onclick="closeMenu()"></div>

  <!-- Main Content -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    
    <!-- Dashboard Section -->
    <div id="dashboardSection">
      <!-- Welcome Card -->
      <div class="bg-white/90 backdrop-blur-sm shadow-xl rounded-2xl p-8 mb-8">
        <div class="text-center">
          <h2 class="text-3xl font-bold text-amber-800 mb-4">Welcome to College Collaboration Platform</h2>
          <p class="text-gray-600 text-lg">Connect with students, share your skills, and build amazing projects together!</p>
        </div>
      </div>

      <!-- Students Directory -->
      <div class="bg-white/90 backdrop-blur-sm shadow-xl rounded-2xl p-8">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold text-amber-800">üë• Students Directory</h2>
          <div class="bg-amber-100 px-4 py-2 rounded-full">
            <span class="text-sm font-medium text-amber-800">Total Students: <span id="totalStudents">0</span></span>
          </div>
        </div>

        <!-- Search Section -->
        <div class="mb-6">
          <div class="flex flex-col md:flex-row gap-4">
            <div class="flex-1">
              <input type="text" id="searchInput" placeholder="üîç Search by name or email..."
                     class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none">
            </div>
            <button onclick="toggleFilters()" id="filterToggle"
                    class="bg-amber-600 hover:bg-amber-700 text-white px-6 py-3 rounded-lg transition">
              üîß Filters
            </button>
          </div>
        </div>

        <!-- Advanced Filters (Initially Hidden) -->
        <div id="filtersPanel" class="hidden bg-amber-50 rounded-lg p-6 mb-6 border border-amber-200">
          <h3 class="text-lg font-semibold text-amber-800 mb-4">Advanced Filters</h3>
          
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <!-- Branch Filter -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Branch</label>
              <select id="branchFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-amber-500 focus:border-amber-500">
                <option value="">All Branches</option>
                <option value="CSE">Computer Science & Engineering</option>
                <option value="AIML">AI & Machine Learning</option>
                <option value="ENTC">Electronics & Telecommunications</option>
                <option value="MECH">Mechanical Engineering</option>
                <option value="CIVIL">Civil Engineering</option>
                <option value="EEE">Electrical & Electronics</option>
              </select>
            </div>

            <!-- Year Filter -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Year</label>
              <select id="yearFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-amber-500 focus:border-amber-500">
                <option value="">All Years</option>
                <option value="First Year">First Year</option>
                <option value="Second Year">Second Year</option>
                <option value="Third Year">Third Year</option>
                <option value="Final Year">Final Year</option>
              </select>
            </div>

            <!-- Skills Filter -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Skills</label>
              <select id="skillsFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-amber-500 focus:border-amber-500">
                <option value="">All Skills</option>
                <option value="Web Development">Web Development</option>
                <option value="App Development">App Development</option>
                <option value="UI/UX Design">UI/UX Design</option>
                <option value="Data Science">Data Science</option>
                <option value="Finance">Finance</option>
                <option value="Public Speaking">Public Speaking</option>
                <option value="Digital Marketing">Digital Marketing</option>
              </select>
            </div>

            <!-- Interests Filter -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Interests</label>
              <select id="interestsFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-amber-500 focus:border-amber-500">
                <option value="">All Interests</option>
                <option value="Singing">Singing</option>
                <option value="Dancing">Dancing</option>
                <option value="Reading">Reading</option>
                <option value="Stock Market">Stock Market</option>
                <option value="Content Creation">Content Creation</option>
                <option value="Photography">Photography</option>
                <option value="Sports">Sports</option>
              </select>
            </div>
          </div>

          <!-- Sort and Action Buttons -->
          <div class="mt-6 flex flex-col md:flex-row gap-4 items-end">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Sort By</label>
              <select id="sortBy" class="px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-amber-500 focus:border-amber-500">
                <option value="created_at">Newest First</option>
                <option value="name">Name A-Z</option>
                <option value="branch">Branch A-Z</option>
                <option value="year">Year</option>
              </select>
            </div>

            <!-- Filter Buttons -->
            <div class="flex gap-2">
              <button onclick="applyFilters()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md transition">
                Apply Filters
              </button>
              <button onclick="clearFilters()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md transition">
                Clear All
              </button>
            </div>
          </div>

          <!-- Results Counter -->
          <div class="mt-4 text-sm text-amber-700">
            Showing <span id="filteredCount">0</span> of <span id="totalCount">0</span> students
          </div>
        </div>

        <!-- Students Grid -->
        <div id="studentsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <div class="text-center py-8">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-amber-600 mx-auto"></div>
            <p class="text-gray-600 mt-2">Loading students...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Profile Form Section (Hidden by default) -->
    <div id="profileFormSection" class="hidden">
      <div class="bg-white/90 backdrop-blur-sm shadow-xl rounded-2xl p-8">
        <h2 class="text-2xl font-bold text-amber-800 mb-6">üìù Submit Your Student Profile</h2>
        <p class="text-gray-600 mb-6">Fill out your information to connect with other students and showcase your skills.</p>
        <button onclick="goToProfileForm()" 
                class="bg-amber-600 hover:bg-amber-700 text-white px-8 py-3 rounded-lg shadow-md transition-all duration-200 transform hover:scale-105">
          Go to Profile Form
        </button>
      </div>
    </div>

    <!-- Edit Profile Section (Hidden by default) -->
    <div id="editProfileSection" class="hidden">
      <div class="bg-white/90 backdrop-blur-sm shadow-xl rounded-2xl p-8">
        <h2 class="text-2xl font-bold text-amber-800 mb-6">‚úèÔ∏è Edit Profile</h2>
        <p class="text-gray-600 mb-6">Update your student information and preferences.</p>
        <p class="text-amber-600">Edit functionality coming soon...</p>
      </div>
    </div>

    <!-- Settings Section (Hidden by default) -->
    <div id="settingsSection" class="hidden">
      <div class="bg-white/90 backdrop-blur-sm shadow-xl rounded-2xl p-8">
        <h2 class="text-2xl font-bold text-amber-800 mb-6">‚öôÔ∏è Account Settings</h2>
        <p class="text-gray-600 mb-6">Manage your account preferences and privacy settings.</p>
        <p class="text-amber-600">Settings functionality coming soon...</p>
      </div>
    </div>

  </main>

    <script>
        // Authentication check - MUST be at the top
        function checkAuthentication() {
        const token = sessionStorage.getItem('token');
        console.log('Checking authentication, token:', token ? 'exists' : 'missing');
        
        if (!token) {
            console.log('No token found, redirecting to login...');
            window.location.href = '/login.html';
            return false;
        }
        return true;
        }

        // Check authentication immediately when page loads
        if (!checkAuthentication()) {
        // Stop script execution if not authenticated
        throw new Error('Not authenticated');
        }

        // Global variables
        let allStudents = [];
        let filteredStudents = [];
        let filtersVisible = false;
        let menuVisible = false;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
        console.log('Dashboard loaded for authenticated user');
        loadStudents();
        
        // Add search listener
        document.getElementById('searchInput').addEventListener('input', debounce(performSearch, 300));
        });

        // Updated logout function to clear sessionStorage
        function logout() {
        console.log('Logging out...');
        sessionStorage.removeItem('token');
        sessionStorage.clear(); // Clear all session data
        window.location.href = '/login.html';
        }

        // Rest of your existing JavaScript code stays the same...
        // (Keep all the existing functions: toggleMenu, closeMenu, showDashboard, etc.)
        
        // Menu Functions
        function toggleMenu() {
        const menu = document.getElementById('sideMenu');
        const overlay = document.getElementById('overlay');
        const menuBtn = document.getElementById('menuBtn');
        
        menuVisible = !menuVisible;
        
        if (menuVisible) {
            menu.classList.remove('hidden');
            overlay.classList.remove('hidden');
            menuBtn.textContent = '‚úï Close';
            menuBtn.classList.add('bg-red-600');
            menuBtn.classList.remove('bg-amber-600');
        } else {
            menu.classList.add('hidden');
            overlay.classList.add('hidden');
            menuBtn.textContent = '‚ò∞ Menu';
            menuBtn.classList.remove('bg-red-600');
            menuBtn.classList.add('bg-amber-600');
        }
        }

        function closeMenu() {
        const menu = document.getElementById('sideMenu');
        const overlay = document.getElementById('overlay');
        const menuBtn = document.getElementById('menuBtn');
        
        menuVisible = false;
        menu.classList.add('hidden');
        overlay.classList.add('hidden');
        menuBtn.textContent = '‚ò∞ Menu';
        menuBtn.classList.remove('bg-red-600');
        menuBtn.classList.add('bg-amber-600');
        }

        // Navigation Functions
        function showDashboard() {
        hideAllSections();
        document.getElementById('dashboardSection').classList.remove('hidden');
        closeMenu();
        }

        function showProfileForm() {
        hideAllSections();
        document.getElementById('profileFormSection').classList.remove('hidden');
        closeMenu();
        }

        function showEditProfile() {
        hideAllSections();
        document.getElementById('editProfileSection').classList.remove('hidden');
        closeMenu();
        }

        function showSettings() {
        hideAllSections();
        document.getElementById('settingsSection').classList.remove('hidden');  
        closeMenu();
        }

        function hideAllSections() {
        document.getElementById('dashboardSection').classList.add('hidden');
        document.getElementById('profileFormSection').classList.add('hidden');
        document.getElementById('editProfileSection').classList.add('hidden');
        document.getElementById('settingsSection').classList.add('hidden');
        }

        function goToProfileForm() {
        window.location.href = '/index.html';
        }

        function editProfile() {
        showEditProfile();
        }

        // Load all students
        async function loadStudents() {
        try {
            console.log('Loading students...');
            const response = await fetch('/api/users');
            const result = await response.json();
            
            if (result.success) {
            allStudents = result.data;
            filteredStudents = [...allStudents];
            
            console.log(`‚úÖ Loaded ${allStudents.length} students`);
            updateStudentCount();
            displayStudents(filteredStudents);
            } else {
            throw new Error(result.error || 'Failed to load students');
            }
        } catch (error) {
            console.error('‚ùå Error loading students:', error);
            document.getElementById('studentsGrid').innerHTML = `
            <div class="col-span-full text-center py-8">
                <div class="text-6xl mb-4">‚ö†Ô∏è</div>
                <p class="text-red-600 mb-4">Error loading students: ${error.message}</p>
                <button onclick="loadStudents()" class="bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg transition">Try Again</button>
            </div>
            `;
        }
        }

        // Display students in grid
        function displayStudents(students) {
        const grid = document.getElementById('studentsGrid');
        
        if (students.length === 0) {
            grid.innerHTML = `
            <div class="col-span-full text-center py-12">
                <div class="text-6xl mb-4">üîç</div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">No students found</h3>
                <p class="text-gray-600">Try adjusting your search or filters</p>
            </div>
            `;
            return;
        }
        
        grid.innerHTML = students.map(student => `
            <div class="bg-white border border-amber-200 rounded-xl p-6 shadow-sm hover:shadow-lg transition-shadow">
            <div class="flex justify-between items-start mb-3">
                <div>
                <h3 class="font-semibold text-amber-900">${student.name}</h3>
                <p class="text-sm text-gray-600">${student.email}</p>
                <p class="text-xs text-gray-500">Roll: ${student.roll_number}</p>
                </div>
                <span class="text-xs text-amber-600 bg-amber-100 px-2 py-1 rounded-full">#${student.id}</span>
            </div>
            
            <div class="mb-3">
                <p class="text-sm"><strong>Branch:</strong> ${student.branch || 'N/A'}</p>
                <p class="text-sm"><strong>Year:</strong> ${student.year || 'N/A'}</p>
                <p class="text-sm"><strong>Class:</strong> ${student.class || 'N/A'}</p>
            </div>
            
            ${student.skills && student.skills.length > 0 ? `
                <div class="mb-3">
                <p class="text-xs font-medium text-gray-700 mb-1">Skills:</p>
                <div class="flex flex-wrap gap-1">
                    ${student.skills.map(skill => 
                    `<span class="bg-amber-100 text-amber-800 text-xs px-2 py-1 rounded-full">${skill}</span>`
                    ).join('')}
                </div>
                </div>
            ` : ''}
            
            ${student.interests && student.interests.length > 0 ? `
                <div>
                <p class="text-xs font-medium text-gray-700 mb-1">Interests:</p>
                <div class="flex flex-wrap gap-1">
                    ${student.interests.map(interest => 
                    `<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">${interest}</span>`
                    ).join('')}
                </div>
                </div>
            ` : ''}
            </div>
        `).join('');
        }

        // Search functionality
        function performSearch() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
        
        if (searchTerm === '') {
            filteredStudents = [...allStudents];
        } else {
            filteredStudents = allStudents.filter(student => 
            student.name.toLowerCase().includes(searchTerm) ||
            student.email.toLowerCase().includes(searchTerm)
            );
        }
        
        applyCurrentFilters();
        updateStudentCount();
        displayStudents(filteredStudents);
        
        console.log(`üîç Search for "${searchTerm}" found ${filteredStudents.length} students`);
        }

        // Toggle filters panel
        function toggleFilters() {
        const panel = document.getElementById('filtersPanel');
        const button = document.getElementById('filterToggle');
        
        filtersVisible = !filtersVisible;
        
        if (filtersVisible) {
            panel.classList.remove('hidden');
            button.textContent = 'üîß Hide Filters';
            button.classList.add('bg-gray-600');
            button.classList.remove('bg-amber-600');
        } else {
            panel.classList.add('hidden');
            button.textContent = 'üîß Filters';
            button.classList.remove('bg-gray-600');
            button.classList.add('bg-amber-600');
        }
        }

        // Apply all filters
        function applyFilters() {
        let filtered = [...allStudents];
        
        // Apply search first
        const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
        if (searchTerm !== '') {
            filtered = filtered.filter(student => 
            student.name.toLowerCase().includes(searchTerm) ||
            student.email.toLowerCase().includes(searchTerm)
            );
        }
        
        // Apply filters
        const branch = document.getElementById('branchFilter').value;
        const year = document.getElementById('yearFilter').value;
        const skill = document.getElementById('skillsFilter').value;
        const interest = document.getElementById('interestsFilter').value;
        
        if (branch) {
            filtered = filtered.filter(student => student.branch === branch);
        }
        
        if (year) {
            filtered = filtered.filter(student => student.year === year);
        }
        
        if (skill) {
            filtered = filtered.filter(student => 
            student.skills && student.skills.includes(skill)
            );
        }
        
        if (interest) {
            filtered = filtered.filter(student => 
            student.interests && student.interests.includes(interest)
            );
        }
        
        // Apply sorting
        const sortBy = document.getElementById('sortBy').value;
        filtered.sort((a, b) => {
            switch (sortBy) {
            case 'name':
                return a.name.localeCompare(b.name);
            case 'branch':
                return (a.branch || '').localeCompare(b.branch || '');
            case 'year':
                return (a.year || '').localeCompare(b.year || '');
            case 'created_at':
            default:
                return new Date(b.created_at) - new Date(a.created_at);
            }
        });
        
        filteredStudents = filtered;
        updateStudentCount();
        displayStudents(filteredStudents);
        
        console.log(`üîß Filters applied, showing ${filteredStudents.length} students`);
        }

        // Apply current filters without search
        function applyCurrentFilters() {
        const branch = document.getElementById('branchFilter').value;
        const year = document.getElementById('yearFilter').value;
        const skill = document.getElementById('skillsFilter').value;
        const interest = document.getElementById('interestsFilter').value;
        
        if (branch || year || skill || interest) {
            if (branch) {
            filteredStudents = filteredStudents.filter(student => student.branch === branch);
            }
            
            if (year) {
            filteredStudents = filteredStudents.filter(student => student.year === year);
            }
            
            if (skill) {
            filteredStudents = filteredStudents.filter(student => 
                student.skills && student.skills.includes(skill)
            );
            }
            
            if (interest) {
            filteredStudents = filteredStudents.filter(student => 
                student.interests && student.interests.includes(interest)
            );
            }
        }
        }

        // Clear all filters
        function clearFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('branchFilter').value = '';
        document.getElementById('yearFilter').value = '';
        document.getElementById('skillsFilter').value = '';
        document.getElementById('interestsFilter').value = '';
        document.getElementById('sortBy').value = 'created_at';
        
        filteredStudents = [...allStudents];
        updateStudentCount();
        displayStudents(filteredStudents);
        
        console.log('üßπ All filters cleared');
        }

        // Update student count display
        function updateStudentCount() {
        document.getElementById('totalStudents').textContent = allStudents.length;
        document.getElementById('totalCount').textContent = allStudents.length;
        document.getElementById('filteredCount').textContent = filteredStudents.length;
        }

        // Utility function for debouncing search
        function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
            clearTimeout(timeout);
            func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
        }
    </script>


  
</body>
</html>
